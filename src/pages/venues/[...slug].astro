---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AccordionFAQ from '../../components/AccordionFAQ.astro';
import { getCollection, render } from 'astro:content';
import { localBusinessJsonLd } from '../../lib/jsonld';
import { formatVenueType } from '../../lib/format';

export const prerender = true;

export async function getStaticPaths() {
  const venues = await getCollection('venues');
  return venues.map((venue) => ({
    params: { slug: venue.id },
    props: { venue },
  }));
}

const { venue } = Astro.props;
const { Content } = await render(venue);

const jsonLd = localBusinessJsonLd(
  venue.data.name,
  venue.data.location,
  venue.data.description,
  new URL(Astro.url.pathname, Astro.site).toString(),
);

const maxFlowersShown = 4;
const flowers = venue.data.recommendedFlowers;
const flowersToShow = flowers.slice(0, maxFlowersShown);
const flowersRemaining = flowers.length - maxFlowersShown;

const hasUsefulLinks = venue.data.website || venue.data.sources.length > 0;
---

<BaseLayout
  title={venue.data.name}
  description={venue.data.description}
  jsonLd={jsonLd}
>
  <div class="max-w-3xl mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-6">
      <a href="/" class="hover:text-brand-green transition-colors">Help Center</a>
      <span class="mx-2">/</span>
      <a href="/venues" class="hover:text-brand-green transition-colors">Venue Guides</a>
      <span class="mx-2">/</span>
      <span class="text-brand-charcoal">{venue.data.name}</span>
    </nav>

    <!-- Hero Image -->
    {venue.data.heroImage ? (
      <img
        src={venue.data.heroImage}
        alt={venue.data.name}
        class="w-full h-64 object-cover rounded-2xl mb-6"
      />
    ) : (
      <div class="w-full h-48 rounded-2xl mb-6 bg-gradient-to-br from-brand-sage/30 to-brand-green/20 flex items-center justify-center">
        <span class="text-4xl">ğŸ›ï¸</span>
      </div>
    )}

    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <span class="bg-brand-sage/20 text-brand-green text-xs px-3 py-1 rounded-full">
          {formatVenueType(venue.data.venueType)}
        </span>
        <span class="text-sm text-gray-500">{venue.data.location}</span>
      </div>
      <h1 class="font-serif text-3xl md:text-4xl font-bold text-brand-green leading-tight">
        {venue.data.name}
      </h1>
      <p class="text-gray-600 mt-3 text-lg leading-relaxed">
        {venue.data.description}
      </p>
    </header>

    <!-- Emoji Info Cards Row -->
    <section class="flex flex-wrap gap-3 mb-10">
      <!-- Venue Type -->
      <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center gap-2">
        <span class="text-lg">ğŸ›ï¸</span>
        <div>
          <span class="text-xs text-gray-500 block">Venue Type</span>
          <span class="text-sm font-medium text-brand-charcoal">{formatVenueType(venue.data.venueType)}</span>
        </div>
      </div>

      <!-- Capacity -->
      {venue.data.capacity && (
        <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center gap-2">
          <span class="text-lg">ğŸ‘¥</span>
          <div>
            <span class="text-xs text-gray-500 block">Capacity</span>
            <span class="text-sm font-medium text-brand-charcoal">{venue.data.capacity.min}â€“{venue.data.capacity.max} guests</span>
          </div>
        </div>
      )}

      <!-- Location -->
      <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center gap-2">
        <span class="text-lg">ğŸ“</span>
        <div>
          <span class="text-xs text-gray-500 block">Location</span>
          <span class="text-sm font-medium text-brand-charcoal">{venue.data.location}</span>
        </div>
      </div>

      <!-- Setting -->
      {venue.data.setting && (
        <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center gap-2">
          <span class="text-lg">ğŸŒ¿</span>
          <div>
            <span class="text-xs text-gray-500 block">Setting</span>
            <span class="text-sm font-medium text-brand-charcoal">{venue.data.setting}</span>
          </div>
        </div>
      )}

      <!-- Style -->
      {venue.data.style && (
        <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center gap-2">
          <span class="text-lg">ğŸ’</span>
          <div>
            <span class="text-xs text-gray-500 block">Style</span>
            <span class="text-sm font-medium text-brand-charcoal">{venue.data.style}</span>
          </div>
        </div>
      )}

      <!-- Best Seasons -->
      {venue.data.bestSeasons.length > 0 && (
        <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center gap-2">
          <span class="text-lg">ğŸ—“ï¸</span>
          <div>
            <span class="text-xs text-gray-500 block">Best Seasons</span>
            <span class="text-sm font-medium text-brand-charcoal">
              {venue.data.bestSeasons.map((s: string) => s.charAt(0).toUpperCase() + s.slice(1)).join(', ')}
            </span>
          </div>
        </div>
      )}

      <!-- Recommended Flowers -->
      {flowers.length > 0 && (
        <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center gap-2">
          <span class="text-lg">ğŸŒ¸</span>
          <div>
            <span class="text-xs text-gray-500 block">Recommended Flowers</span>
            <span class="text-sm font-medium text-brand-charcoal">
              {flowersToShow.join(', ')}{flowersRemaining > 0 ? ` +${flowersRemaining} more` : ''}
            </span>
          </div>
        </div>
      )}
    </section>

    <!-- Logistics -->
    {venue.data.logistics && (
      <section class="mb-10">
        <h2 class="font-serif text-xl font-semibold text-brand-charcoal mb-4">Logistics & Setup</h2>
        <div class="bg-white rounded-xl p-6 border border-gray-100 space-y-4">
          {venue.data.logistics.setupTime && (
            <div>
              <h4 class="text-sm font-semibold text-brand-sage uppercase tracking-wide">Setup Time</h4>
              <p class="text-gray-700 mt-1">{venue.data.logistics.setupTime}</p>
            </div>
          )}
          {venue.data.logistics.loadInNotes && (
            <div>
              <h4 class="text-sm font-semibold text-brand-sage uppercase tracking-wide">Load-In Notes</h4>
              <p class="text-gray-700 mt-1">{venue.data.logistics.loadInNotes}</p>
            </div>
          )}
          {venue.data.logistics.restrictions.length > 0 && (
            <div>
              <h4 class="text-sm font-semibold text-brand-sage uppercase tracking-wide">Restrictions</h4>
              <ul class="mt-2 space-y-1">
                {venue.data.logistics.restrictions.map((r: string) => (
                  <li class="flex items-start gap-2 text-sm text-gray-700">
                    <span class="text-red-400 mt-0.5 flex-shrink-0">&#9679;</span>
                    {r}
                  </li>
                ))}
              </ul>
            </div>
          )}
          {venue.data.logistics.contactInfo && (
            <div>
              <h4 class="text-sm font-semibold text-brand-sage uppercase tracking-wide">Contact</h4>
              <p class="text-gray-700 mt-1">{venue.data.logistics.contactInfo}</p>
            </div>
          )}
        </div>
      </section>
    )}

    <!-- Seasonal Notes -->
    {venue.data.seasonalNotes && (
      <section class="mb-10">
        <h2 class="font-serif text-xl font-semibold text-brand-charcoal mb-4">Seasonal Notes</h2>
        <div class="bg-brand-blush rounded-xl p-6">
          <p class="text-gray-700 leading-relaxed">{venue.data.seasonalNotes}</p>
        </div>
      </section>
    )}

    <!-- Full Content -->
    <div class="prose prose-lg prose-green max-w-none prose-headings:font-serif prose-headings:text-brand-green prose-a:text-brand-green prose-a:underline-offset-2">
      <Content />
    </div>

    <!-- FAQ Accordion -->
    {venue.data.faqItems && venue.data.faqItems.length > 0 && (
      <section class="mt-12 mb-10">
        <h2 class="font-serif text-xl font-semibold text-brand-charcoal mb-4">Frequently Asked Questions</h2>
        <AccordionFAQ items={venue.data.faqItems} />
      </section>
    )}

    <!-- Useful Links -->
    {hasUsefulLinks && (
      <section class="mt-10 mb-10">
        <h2 class="font-serif text-xl font-semibold text-brand-charcoal mb-4">Useful Links</h2>
        <div class="bg-white rounded-xl p-6 border border-gray-100 space-y-3">
          {venue.data.website && (
            <a
              href={venue.data.website}
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-center gap-3 text-brand-green hover:text-brand-sage transition-colors"
            >
              <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              <span class="font-medium">Official Website</span>
            </a>
          )}
          {venue.data.sources.map((source: { label: string; url: string }) => (
            <a
              href={source.url}
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-center gap-3 text-brand-green hover:text-brand-sage transition-colors"
            >
              <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              <span class="font-medium">{source.label}</span>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Back Link -->
    <div class="mt-12">
      <a href="/" class="text-brand-green hover:text-brand-sage transition-colors text-sm font-medium">
        &larr; Back to Help Center
      </a>
    </div>
  </div>
</BaseLayout>
