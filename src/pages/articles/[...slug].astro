---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { faqPageJsonLd, articleJsonLd } from '../../lib/jsonld';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map((article) => ({
    params: { slug: article.id },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await render(article);

const jsonLd: Record<string, unknown>[] = [
  articleJsonLd(
    article.data.title,
    article.data.description,
    article.data.author,
    article.data.publishedDate,
    new URL(Astro.url.pathname, Astro.site).toString(),
    article.data.updatedDate,
  ),
];

if (article.data.faqItems?.length) {
  jsonLd.push(
    faqPageJsonLd(article.data.faqItems, new URL(Astro.url.pathname, Astro.site).toString()),
  );
}
---

<BaseLayout
  title={article.data.title}
  description={article.data.description}
  metaTitle={article.data.seo?.metaTitle}
  metaDescription={article.data.seo?.metaDescription}
  ogImage={article.data.seo?.ogImage}
  jsonLd={jsonLd}
>
  <article class="max-w-3xl mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-6">
      <a href="/" class="hover:text-brand-green transition-colors">Help Center</a>
      <span class="mx-2">/</span>
      <a href={`/categories/${article.data.category}`} class="hover:text-brand-green transition-colors capitalize">
        {article.data.category.replace(/-/g, ' ').replace(/\b\w/g, (c: string) => c.toUpperCase())}
      </a>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <h1 class="font-serif text-3xl md:text-4xl font-bold text-brand-green leading-tight">
        {article.data.title}
      </h1>
      <p class="text-gray-600 mt-3 text-lg leading-relaxed">
        {article.data.description}
      </p>
      <div class="flex items-center gap-4 mt-4 text-sm text-gray-500">
        <span>By {article.data.author}</span>
        <span>&middot;</span>
        <time datetime={article.data.publishedDate.toISOString()}>
          {article.data.publishedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
      </div>
      {article.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4">
          {article.data.tags.map((tag: string) => (
            <span class="bg-brand-sage/20 text-brand-green text-xs px-3 py-1 rounded-full">
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    <!-- Content -->
    <div class="prose prose-lg prose-green max-w-none prose-headings:font-serif prose-headings:text-brand-green prose-a:text-brand-green prose-a:underline-offset-2">
      <Content />
    </div>

    <!-- FAQ Section -->
    {article.data.faqItems && article.data.faqItems.length > 0 && (
      <section class="mt-12 bg-brand-blush rounded-xl p-8">
        <h2 class="font-serif text-2xl font-bold text-brand-green mb-6">Frequently Asked Questions</h2>
        <dl class="space-y-6">
          {article.data.faqItems.map((faq: { question: string; answer: string }) => (
            <div>
              <dt class="font-semibold text-brand-charcoal">{faq.question}</dt>
              <dd class="mt-2 text-gray-600 leading-relaxed">{faq.answer}</dd>
            </div>
          ))}
        </dl>
      </section>
    )}
  </article>
</BaseLayout>
