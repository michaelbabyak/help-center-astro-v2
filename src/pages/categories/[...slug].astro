---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { websiteJsonLd } from '../../lib/jsonld';

export const prerender = true;

export async function getStaticPaths() {
  const categories = await getCollection('categories');
  return categories.map((category) => ({
    params: { slug: category.id },
    props: { category },
  }));
}

const { category } = Astro.props;
const { Content } = await render(category);

const articles = await getCollection('articles');
const categoryArticles = articles.filter((a) => a.data.category === category.id);

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: category.data.title,
  description: category.data.description,
  url: new URL(Astro.url.pathname, Astro.site).toString(),
  isPartOf: websiteJsonLd('https://help.poppyflowers.com'),
};
---

<BaseLayout
  title={category.data.title}
  description={category.data.description}
  jsonLd={jsonLd}
>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-6">
      <a href="/" class="hover:text-brand-green transition-colors">Help Center</a>
      <span class="mx-2">/</span>
      <span class="text-brand-charcoal">Categories</span>
    </nav>

    <!-- Header -->
    <header class="mb-10">
      <div class="flex items-center gap-4 mb-4">
        {category.data.icon && <span class="text-4xl">{category.data.icon}</span>}
        <h1 class="font-serif text-3xl md:text-4xl font-bold text-brand-green">
          {category.data.title}
        </h1>
      </div>
      <div class="text-gray-600 text-lg leading-relaxed prose prose-green max-w-none">
        <Content />
      </div>
    </header>

    <!-- Articles in Category -->
    {categoryArticles.length > 0 ? (
      <section>
        <h2 class="font-serif text-xl font-semibold text-brand-charcoal mb-4">
          Articles ({categoryArticles.length})
        </h2>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 divide-y divide-gray-100">
          {categoryArticles.map((article) => (
            <a
              href={`/articles/${article.id}`}
              class="flex items-center justify-between p-5 hover:bg-gray-50 transition-colors group"
            >
              <div>
                <h3 class="font-medium text-brand-charcoal group-hover:text-brand-green transition-colors">
                  {article.data.title}
                </h3>
                <p class="text-sm text-gray-500 mt-1">{article.data.description}</p>
              </div>
              <span class="text-brand-sage text-xl ml-4 flex-shrink-0">&rarr;</span>
            </a>
          ))}
        </div>
      </section>
    ) : (
      <div class="bg-white rounded-xl p-8 text-center border border-gray-100">
        <p class="text-gray-500">No articles in this category yet. Check back soon!</p>
      </div>
    )}

    <!-- Back Link -->
    <div class="mt-8">
      <a href="/" class="text-brand-green hover:text-brand-sage transition-colors text-sm font-medium">
        &larr; Back to Help Center
      </a>
    </div>
  </div>
</BaseLayout>
